<?xml version="1.0" encoding="utf-8" ?>
<voicemail>
<!-- innovaphone Spoken Presence == inno srl V1.01 CAN 2012 -->
<!-- Function to obtain Time/Date and set Presence Type with Note plus CFU to spoken_prompts_test.xml -->
  <function define="setpresence">  	<index out="$res1" value="$dialednumber" pos="1" size="3"/>	  <index out="$res2" value="$dialednumber" pos="4" size="4"/>	  	  <index out="$year" value="$dialednumber" pos="9" size="2"/>	  	    	  <lib-strcat string="$presencetype" string2="$res1" out-string="$presencetype"/>	  	  <lib-strcat string="$time" string2="$res2" out-string="$time"/>	  	  <lib-strcat string="$date" string2="$res2" out-string="$date"/>	  	    	  <index out="$hour" value="$time" pos="1" size="2"/>	  <index out="$minute" value="$time" pos="3" size="2"/>	  	  <index out="$month" value="$date" pos="1" size="2"/>	  <index out="$day" value="$date" pos="3" size="2"/>	    	    <switch var="$presencetype">		<!-- 100XXXX Clear Presence and CFU -->								<case equal="100">										<pbx-set-presence name="$cn"/>					<pbx-upd-obj name="$cn" type="cfu" value=""/>					                                        </case>	<!-- 101XXXX Set Away with note of time and CFU -->					                    <case equal="101">										<lib-strcat out-string="$part1" string="$hour" string2=":" />					<lib-strcat out-string="$hourminute" string="$part1" string2="$minute" />					<lib-strcat out-string="$note" string="Im away until " string2="$hourminute" />                    <pbx-set-presence name="$cn" activity="away" note="$note" />					<pbx-upd-obj name="$cn" type="cfu" value="$spokenprompt"/>                                        </case>	<!-- 102XXXX Set Busy with note of time and CFU -->		                <case equal="102">										<lib-strcat out-string="$part1" string="$hour" string2=":" />					<lib-strcat out-string="$hourminute" string="$part1" string2="$minute" />					<lib-strcat out-string="$note" string="Im busy until " string2="$hourminute" />					<pbx-set-presence name="$cn" activity="busy" note="$note" />					<pbx-upd-obj name="$cn" type="cfu" value="$spokenprompt"/>					                                          </case>	<!-- 103XXXX Set Lunch with note of time and CFU -->										<case equal="103">										<lib-strcat out-string="$part1" string="$hour" string2=":" />					<lib-strcat out-string="$hourminute" string="$part1" string2="$minute" />					<lib-strcat out-string="$note" string="At lunch break until " string2="$hourminute" />					<pbx-set-presence name="$cn" activity="lunch" note="$note" />					<pbx-upd-obj name="$cn" type="cfu" value="$spokenprompt"/>						                                          </case>	<!-- 104XXXX Set Meeting with note of time and CFU -->										<case equal="104">										<lib-strcat out-string="$part1" string="$hour" string2=":" />					<lib-strcat out-string="$hourminute" string="$part1" string2="$minute" />					<lib-strcat out-string="$note" string="In meeting until " string2="$hourminute" />					<pbx-set-presence name="$cn" activity="meeting" note="$note" />					<pbx-upd-obj name="$cn" type="cfu" value="$spokenprompt"/>										</case>		<!-- 105XXXX Set Vacation with note of date and CFU -->										<case equal="105">						<switch var="$year">							<case equal="0">														<lib-strcat out-string="$part1" string="$day" string2="/" />							<lib-strcat out-string="$daymonth" string="$part1" string2="$month" />							<lib-strcat out-string="$note" string="On vacation until " string2="$daymonth" />							<pbx-set-presence name="$cn" activity="vacation" note="$note" />                      							<pbx-upd-obj name="$cn" type="cfu" value="$spokenprompt"/>																					</case>														<case not-equal="0">														<lib-strcat out-string="$part1" string="$day" string2="/" />							<lib-strcat out-string="$daymonth" string="$part1" string2="$month" />							<lib-strcat out-string="$part2" string="$daymonth" string2="/" />							<lib-strcat out-string="$daymonthyear" string="$part2" string2="$year" />							<lib-strcat out-string="$note" string="On vacation until " string2="$daymonthyear" />							<pbx-set-presence name="$cn" activity="vacation" note="$note" />                      							<pbx-upd-obj name="$cn" type="cfu" value="$spokenprompt"/>												</case>						</switch>					</case>						<!-- Wrong presence code -->											<case not-equal="100">						<store-get root="" name="en_an_error_occurred.$coder" out-url="$ctrl-error" />						<pbx-prompt url="$ctrl-error" />					</case>                                                     </switch>            	</function>   
	<function define="Main">	
		<assign out="$presencetype" value="" />		<assign out="$time" value=""/>		<assign out="$date" value=""/>		<assign out="$abort" value=""/>		<assign out="$dtmflength" value=""/>		<assign out="$dialednumber" value=""/>		<assign out="$year" value="0"/>				<!-- Insert value with number of spoken_prompts.xml vm object below Ex:831-->		<assign out="$spokenprompt" value="831"/>
	<!-- Find which PBX User-->
		<pbx-getcallinfo out-cgpn="$cgpn" out-leg2="$leg2"/>        <pbx-finduser-e164 e164="$cgpn" out-cn="$cn" />

	<!-- Get DTMF entry for presence type-->
		<event type="dtmf" block="false">
			<pbx-getdtmfdigit out-dtmf="$dtmf" />
		<lib-strcat string="$dialednumber" string2="$dtmf" out-string="$dialednumber"/>		<lib-strlen out="$dtmflength" string="$dialednumber"/>	  
		</event>
        <while notcond="$abort">
            <if notcond="$abort">
                    <!-- Silence. 4s -->
                <store-get root="" name="silence.$coder" out-url="$ctrl" />                <pbx-prompt url="$ctrl" sec="4" repeat="true"/>
                    <!--Set presence type on the User-->    
                <switch var="$dtmflength">									<case greater-equal="7">                        <call name="setpresence" />                        <assign out="$abort" value="true"/>                    </case>									</switch>                        </if>		</while>  	    <pbx-disc/>
    </function>    
</voicemail>
<!-- Spoken Presence with VoiceMail XML Script wiki-src/xml/spokepre 1,0,1,0 (C) innovaphone AG 2010-2012 -->
