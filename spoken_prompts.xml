<?xml version="1.0" encoding="utf-8" ?>
<voicemail>
<!-- innovaphone Spoken Presence == inno srl V1.01 CAN 2012 -->   	<function define="PromptTime">		<!-- AM, PM. Scale hours between 1..12 -->                        <store-get root="" name="en_pm.$coder" out-url="$ctrl-ampm" />                        <switch var="$hour">                            <case less="12">                                <store-get root="" name="en_am.$coder" out-url="$ctrl-ampm" />                            </case>                        </switch>                        <switch var="$hour">                            <case greater="12">                                <sub value="$hour" value2="12" out="$hour"/>                            </case>                            <case equal="0">                                <assign out="$hour" value="12"/>                            </case>                        </switch>                            <!-- Hour -->                        <lib-strcat string="en_" string2="$hour" out-string="$fileprefix" />                        <lib-strcat string="$fileprefix" string2=".$coder" out-string="$filename" />                        <store-get root="" name="$filename" out-url="$ctrl-hour" />                            <!-- Minute -->                        <lib-strcat string="en_" string2="$minute" out-string="$fileprefix" />                        <lib-strcat string="$fileprefix" string2=".$coder" out-string="$filename" />                        <store-get root="" name="$filename" out-url="$ctrl-min" />                        <assign out="$ctrl-min-0" value=""/>                        <switch var="$minute">                            <case less="10">                               <store-get root="" name="en_o.$coder" out-url="$ctrl-min-0" />                            </case>                        </switch>                        <if notcond="$dtmf">                            <pbx-prompt url="$ctrl-hour"/>                        </if>                        <if notcond="$dtmf">                            <if cond="$ctrl-min-0">                                <pbx-prompt url="$ctrl-min-0"/>                            </if>                            <pbx-prompt url="$ctrl-min"/>                        </if>                        <if notcond="$dtmf">                            <pbx-prompt url="$ctrl-ampm"/>                        </if>        			</function>		<function define="PromptDate">		<!-- Day Of Month -->                        <lib-strcat string="en_" string2="$day" out-string="$fileprefix" />                        <lib-strcat string="$fileprefix" string2="_ord.$coder" out-string="$filename" />                        <store-get root="" name="$filename" out-url="$ctrl-day" />                            <!-- Month -->                        <lib-strcat string="en_month_" string2="$month" out-string="$fileprefix" />                        <lib-strcat string="$fileprefix" string2=".$coder" out-string="$filename" />                        <store-get root="" name="$filename" out-url="$ctrl-month" />                						<if notcond="$dtmf">							<pbx-prompt url="$ctrl-month"/>						</if>                        <if notcond="$dtmf">							<pbx-prompt url="$ctrl-day"/>                        </if>		</function>
	<function define="Main">	
		<assign out="$presencetype" value="" />		<assign out="$note" value="" />		<assign out="$cn" value=""/>
		<assign out="$abort" value=""/>
	<!-- Find which PBX User with CFU-->
		<pbx-getcallinfo out-cdpn="$cdpn" out-leg2="$leg2"/>        <pbx-finduser-e164 e164="$leg2" out-cn="$cn" />
	<!-- Get Presence Status and note-->			<pbx-get-presence name="$cn" out-activity="$a" out-note="$n"/>				<lib-strcat string="$presencetype" string2="$a" out-string="$presencetype"/>		<lib-strcat string="$note" string2="$n" out-string="$note"/>		
        <while notcond="$abort">            <if notcond="$abort">                    <!-- Silence. 4s -->                <store-get root="" name="silence.$coder" out-url="$ctrl" />                <pbx-prompt url="$ctrl" sec="2" repeat="true"/>                                <!-- Play Prompt based on presencetype-->    				<switch var="$presencetype">				<case equal="away">                        <index out="$hour" value="$note" pos="15" size="2"/>						<index out="$minute" value="$note" pos="18" size="2"/>						<store-get root="" name="away.$coder" out-url="$ctrl-away" />						<pbx-prompt url="$ctrl-away"/>						<call name="PromptTime" />												<assign out="$abort" value="true"/>                </case>				<case equal="busy">						<index out="$hour" value="$note" pos="15" size="2"/>						<index out="$minute" value="$note" pos="18" size="2"/>						<store-get root="" name="busy.$coder" out-url="$ctrl-busy" />						<pbx-prompt url="$ctrl-busy"/>						<call name="PromptTime" />												<assign out="$abort" value="true"/>                 </case>
				<case equal="lunch">						<index out="$hour" value="$note" pos="22" size="2"/>						<index out="$minute" value="$note" pos="25" size="2"/>						<store-get root="" name="lunch.$coder" out-url="$ctrl-lunch" />						<pbx-prompt url="$ctrl-lunch"/>						<call name="PromptTime" />												<assign out="$abort" value="true"/>                    </case>									<case equal="meeting">						<index out="$hour" value="$note" pos="18" size="2"/>						<index out="$minute" value="$note" pos="21" size="2"/>						<store-get root="" name="meeting.$coder" out-url="$ctrl-meeting" />						<pbx-prompt url="$ctrl-meeting"/>						<call name="PromptTime" />												<assign out="$abort" value="true"/>				</case>				<case equal="vacation">						<index out="$day" value="$note" pos="19" size="2"/>						<index out="$month" value="$note" pos="22" size="2"/>						<index out="$year" value="$note" pos="25" size="2"/>						<store-get root="" name="vacation.$coder" out-url="$ctrl-vacation" />						<pbx-prompt url="$ctrl-vacation"/>						<call name="PromptDate" />												<assign out="$abort" value="true"/>	                    </case>										<!-- Breakout if no presence status available-->				<case not-equal="away">					<store-get root="" name="en_an_error_occurred.$coder" out-url="$ctrl-error" />					<pbx-prompt url="$ctrl-error" />					<assign out="$abort" value="true"/>				</case>					                  
                </switch>                        </if>
        </while>  	  				<!--Transfer to Innovaphone Voicemail after Prompt 		    Change $vmnumber value to the Innovaphone VM Box number and $vm_redirect value to the name of the VM Dummy User Object created		-->		<assign out="$vmbox" value=""/>		<assign out="$vmnumber" value="0"/>		<assign out="$vm_redirect" value="vm_spoken_vmredirect"/>				<switch var="$vmnumber">			<case not-equal="0">				<lib-strcat out-string="$vmbox" string="$vmnumber" string2="$leg2"/>				<pbx-upd-obj name="$vm_redirect" type="cfu" value="$vmbox"/>				<pbx-fwd name="$vm_redirect" />				<pbx-upd-obj name="$vm_redirect" type="cfu" value=""/>			</case>					</switch>				<pbx-disc/>
    </function>    
</voicemail>
<!-- Spoken Presence with VoiceMail XML Script wiki-src/xml/spokepre 1,0,1,0 (C) innovaphone AG 2010-2012 -->
